\chapter{Arquitectura}

\section{Introducción}
%-------------------------------------------------------------------
\label{cap1:sec:introduccion}
En este capítulo se explicará la arquitectura de toda la aplicación en detalle.\\
En la primera sección se explicará la arquitectura general de toda la aplicación: que papeles básicos juegan el cliente y el servidor dentro de nuestra aplicación, mientras que en los siguientes apartados se describirá de forma más detallada la arquitectura de cada uno. 

\section{Arquitectura general de la aplicación}
\label{cap1:sec:arquitecturaGeneral}
La arquitectura de este proyecto sigue el patrón típico de cliente-servidor, donde el cliente se encarga de la interacción del sistema con el usuario, mientras que la función del servidor consiste en asegurarse de que se cumplan todas las reglas de negocio y de interactuar con la base de datos.
En muchos casos, el lado del cliente no permite introducir datos erróneos con el objetivo de mejorar la experiencia de usuario, aun así el servidor vuelve a comprobar la validez de estos datos.
Además el cliente es también el encargado de hacer de intermediario con la API que gestiona los mapas, esto es debido a que queremos evitar sobrecargar el servidor con demasiadas peticiones y aunque hubiéramos querido, el plan gratuito de Firebase no permite conectar el servidor con servicios externos a Google.
El diálogo entre cliente y servidor se realiza mediante peticiones https.
Con todo esto, la aplicación tendría la estructura básica de la figura~\ref{fig:arquitecturaGeneral}.

\figura{Vectorial/arquitecturaGeneral}{width=.9\textwidth}{fig:arquitecturaGeneral}%
{Arquitectura general de la aplicación.}

\section{Arquitectura del cliente}
\label{cap1:sec:arquitecturacliente}


\section{Arquitectura del servidor}
\label{cap1:sec:arquitecturaservidor}
El servidor tiene una arquitectura multicapa formada por tres partes bien delimitadas:
\begin{itemize}  
    \item Controlador frontal: Representado por el archivo "index.js". Es el encargado de recibir las peticiones. Además también realiza pequeñas validaciones de datos que están estrechamente ligados al formato de las peticiones y que podrían suponer un error de ejecución (ej: comprobar que no lleguen los datos vacíos) y validaciones de autorización (ej: comprobar que el usuario que ha mandado la petición de eliminar un origen es un administrador);
    \item Capa de negocio: Formada por todos los servicios de aplicación ubicados en la carpeta "business". El objetivo de esta capa es asegurarse de que se cumplen las diferentes reglas de negocio (ej: No se pueden añadir más pasajeros a un viaje si están todas las plazas ocupadas).
    \item Capa de integración: Formada por los "Data Access Objects" (DAOs) de la carpeta "dataAccess". Esta capa se encarga de dar acceso al sistema a la base de datos mediante operaciones simples (insertar, borrar, modificar y leer). Además esta capa contiene un archivo "database.js" que se encarga de realizar la configuración necesaria para hacer las peticiones a la base de datos.
\end{itemize}
Para el manejo de errores tenemos un archivo "errors.js", donde se encuentran todos los errores posibles que le pueden llegar al cliente junto a una descripción de cual puede ser la causa. Para solucionar el problema de la asincronía a la hora de interactuar con la base de datos, utilizamos promesas, por lo que todas las funciones devuelven siempre una promesa.\\
Una vez que el cliente ha enviado una petición, el servidor se realiza los clientes pasos:
\begin{enumerate}
    \item Se ejecuta la función del controlador asociada a la petición, donde primeramente se realizan comprobaciones de autorización y validación de datos, si no ha ocurrido ningún error, se llamará a una función de algún servicio de aplicación.
    \item El servicio de aplicación lleva a cabo las reglas de negocio llamando a las funciones de los DAOs, asegurándose de que todos los datos sean coherentes y de que se cumplan todas las restricciones.
    \item Los DAOs interactúan directamente con la base de datos obteniendo, insertando, modificando y borrando información.
\end{enumerate}
Esta separación en capas permite que la lógica de negocio no dependa de la plataforma en la que se esta desarrollando: Si queremos cambiar el servicio que aloja el código del servidor solo habría que hacer cambios en el controlador, mientras que si cambiamos la forma en la que los datos son almacenados, solo habría que cambiar los DAOs. En el siguiente capítulo veremos qué servicios hemos usado para desarrollar la aplicación y cómo.
%-------------------------------------------------------------------
\section*{\NotasBibliograficas}
%-------------------------------------------------------------------
\TocNotasBibliograficas

Citamos algo para que aparezca en la bibliografía\ldots
\citep{ldesc2e}

\medskip

Y también ponemos el acrónimo \ac{CVS} para que no cruja.

Ten en cuenta que si no quieres acrónimos (o no quieres que te falle la compilación en ``release'' mientras no tengas ninguno) basta con que no definas la constante \verb+\acronimosEnRelease+ (en \texttt{config.tex}).


%-------------------------------------------------------------------
\section*{\ProximoCapitulo}
%-------------------------------------------------------------------
\TocProximoCapitulo

...

% Variable local para emacs, para  que encuentre el fichero maestro de
% compilación y funcionen mejor algunas teclas rápidas de AucTeX
%%%
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../Tesis.tex"
%%% End:
